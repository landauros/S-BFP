<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>S-BFP Testing Platform</title>
  <style>
    /* ========== Global Base Styles ========== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f8fafc;
      color: #333;
      margin: 0;
      text-align: center;
    }
    h1 {
      margin-top: 40px;
      color: #1e293b;
      font-weight: 600;
    }

    /* ========== Authentication Modal Styles ========== */
    #overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15, 23, 42, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .auth-box {
      background: white;
      padding: 40px 32px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      width: 320px;
      text-align: center;
      transition: all 0.3s ease;
    }
    .auth-box h3 {
      margin-bottom: 24px;
      color: #0f172a;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .auth-box input {
      width: 100%;
      padding: 10px 12px;
      margin: 8px 0;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .auth-box input:focus {
      border-color: #22d3ee;
      box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.25);
    }
    .auth-box button {
      width: 100%;
      padding: 10px;
      background: linear-gradient(90deg, #14b8a6, #06b6d4);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 16px;
      transition: background 0.25s;
    }
    .auth-box button:hover {
      background: linear-gradient(90deg, #0d9488, #0891b2);
    }
    .auth-box a {
      display: inline-block;
      margin-top: 12px;
      font-size: 13px;
      color: #475569;
      text-decoration: none;
      transition: color 0.2s;
    }
    .auth-box a:hover {
      color: #0e7490;
    }
    #passwordWrapper {
      width: 100%;
    }
    .auth-helper {
      font-size: 12px;
      color: #64748b;
      margin: 4px 0 0;
      min-height: 18px;
    }

    .generated-password {
      display: none;
      margin-top: 16px;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: #f8fafc;
      text-align: left;
    }
    .generated-password label {
      display: block;
      font-size: 13px;
      color: #0f172a;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .generated-password-value {
      font-family: monospace;
      font-size: 14px;
      padding: 8px 10px;
      background: #0f172a;
      color: #f8fafc;
      border-radius: 6px;
      margin-bottom: 8px;
      word-break: break-all;
    }
    .generated-password button {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 6px;
      background: #14b8a6;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    .generated-password button:hover {
      background: #0d9488;
    }

    /* ========== Test Status Modal Styles ========== */
    #test-status-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.65);
      z-index: 9800;
    }
    #test-status-box {
      background: white;
      padding: 24px 32px;
      border-radius: 12px;
      width: 360px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      font-size: 16px;
      color: #0f172a;
      line-height: 1.6;
    }
    .fingerprint-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: none;
      margin: 0 auto 16px;
      background-size: cover;
    }
    .fingerprint-icon.success {
      display: inline-flex;
      background-image:
        repeating-radial-gradient(circle at center, rgba(255, 255, 255, 0.25) 0 6px, transparent 6px 12px),
        radial-gradient(circle at center, #22c55e 0%, #16a34a 70%, rgba(34, 197, 94, 0.7) 100%);
    }
    .fingerprint-icon.error {
      display: inline-flex;
      background-image:
        repeating-radial-gradient(circle at center, rgba(255, 255, 255, 0.25) 0 6px, transparent 6px 12px),
        radial-gradient(circle at center, #ef4444 0%, #dc2626 70%, rgba(239, 68, 68, 0.7) 100%);
    }
  </style>

    <script type="module">
    import { getFullFingerprint } from "/webgl/preliminary_fingerprint.js";

    async function captureFingerprint(username) {
      if (!username) return;
      try {
        const fingerprint = await getFullFingerprint();
        await fetch("/user/fingerprint", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username,
            timestamp: new Date().toISOString(),
            fingerprintHash: fingerprint.hash,
            fingerprintString: fingerprint.string,
            fingerprint: fingerprint.raw,
          }),
        });
      } catch (error) {
        console.error("Static fingerprint capture failed:", error);
      }
    }

    const testProgress = {
      webgl: { status: "idle", message: "", serverStable: null },
      audio: { status: "idle", message: "", serverStable: null },
      canvas: { status: "idle", message: "", serverStable: null },
    };
    let testStatusModal = null;
    let testStatusText = null;
    let testStatusIcon = null;
    let sessionToken = null;
    let pendingSessionReleasePayload = null;
    let sessionHeartbeatTimer = null;
    let sessionReleased = true;
    const SESSION_HEARTBEAT_MIN_INTERVAL = 10;
    let overlayCloseTimer = null;

    function clearSessionHeartbeat() {
      if (sessionHeartbeatTimer) {
        clearInterval(sessionHeartbeatTimer);
        sessionHeartbeatTimer = null;
      }
    }

    function scheduleSessionHeartbeat(timeoutSeconds) {
      clearSessionHeartbeat();
      const intervalSeconds = Math.max(
        SESSION_HEARTBEAT_MIN_INTERVAL,
        Math.floor((timeoutSeconds || 60) / 2)
      );
      sessionHeartbeatTimer = setInterval(() => {
        if (!sessionToken || sessionReleased) return;
        sendSessionHeartbeat().catch((error) => {
          console.warn("Heartbeat failed:", error);
        });
      }, intervalSeconds * 1000);
    }

    async function acquireExclusiveSession(username) {
      try {
        const res = await fetch("/session/acquire", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username }),
        });
        const result = await res.json();
        if (!res.ok) {
          const err = result.error || result.message || res.statusText;
          return { success: false, error: err };
        }
        if (result.status === "busy") {
          return {
            success: false,
            busy: true,
            owner: result.owner,
            startedAt: result.startedAt || null,
          };
        }
        if (result.status !== "ok" || !result.token) {
          return {
            success: false,
            error: result.error || "Failed to acquire exclusive session.",
          };
        }
        sessionToken = result.token;
        pendingSessionReleasePayload = {
          username: result.username || username,
          token: result.token,
        };
        sessionReleased = false;
        scheduleSessionHeartbeat(result.timeout);
        return { success: true, timeout: result.timeout };
      } catch (error) {
        return { success: false, error: error.message || String(error) };
      }
    }

    async function sendSessionHeartbeat() {
      if (!window.currentUser || !sessionToken) return;
      const res = await fetch("/session/heartbeat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: window.currentUser, token: sessionToken }),
      });
      if (!res.ok) {
        const result = await res.json().catch(() => ({}));
        throw new Error(result.error || res.statusText);
      }
    }

    async function releaseExclusiveSession(reason = "manual", useBeacon = false, force = false) {
      const payload = pendingSessionReleasePayload || (sessionToken
        ? { username: window.currentUser, token: sessionToken }
        : null);
      if (!window.currentUser || !payload) return;
      if (sessionReleased && !force) return;

      sessionReleased = true;
      clearSessionHeartbeat();
      const bodyPayload = { ...payload, reason };

      if (useBeacon && navigator.sendBeacon) {
        try {
          const blob = new Blob([JSON.stringify(bodyPayload)], {
            type: "application/json",
          });
          navigator.sendBeacon("/session/release", blob);
          sessionToken = null;
          pendingSessionReleasePayload = null;
          return;
        } catch (error) {
          console.warn("Failed to send beacon release:", error);
        }
      }

      try {
        const res = await fetch("/session/release", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyPayload),
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        sessionToken = null;
        pendingSessionReleasePayload = null;
      } catch (error) {
        console.warn("Failed to release session:", error);
        if (navigator.sendBeacon) {
          try {
            const blob = new Blob([JSON.stringify(bodyPayload)], {
              type: "application/json",
            });
            if (navigator.sendBeacon("/session/release", blob)) {
              sessionToken = null;
              pendingSessionReleasePayload = null;
              return;
            }
          } catch (beaconError) {
            console.warn("Beacon release attempt failed:", beaconError);
          }
        }
        if (force) {
          pendingSessionReleasePayload = { ...bodyPayload };
        } else {
          sessionReleased = false;
          pendingSessionReleasePayload = { ...bodyPayload };
        }
      }
    }

    function ensureTestModalElements() {
      if (!testStatusModal) {
        testStatusModal = document.getElementById("test-status-modal");
      }
      if (!testStatusText) {
        testStatusText = document.getElementById("test-status-text");
      }
      if (!testStatusIcon) {
        testStatusIcon = document.getElementById("test-status-icon");
      }
    }

    function setStatusIcon(mode) {
      ensureTestModalElements();
      if (!testStatusIcon) return;
      testStatusIcon.classList.remove("success", "error");
      if (!mode) {
        testStatusIcon.style.display = "none";
        return;
      }
      testStatusIcon.style.display = "inline-flex";
      testStatusIcon.classList.add(mode === "success" ? "success" : "error");
    }

    function showTestingOverlay() {
      ensureTestModalElements();
      if (!testStatusModal || !testStatusText) return;
      testStatusText.textContent = "Tests are running, please do not leave or interact with the page.";
      testStatusModal.style.display = "flex";
    }

    function resetTestProgress() {
      testProgress.webgl = { status: "pending", message: "", serverStable: null };
      testProgress.audio = { status: "pending", message: "", serverStable: null };
      testProgress.canvas = { status: "pending", message: "", serverStable: null };
      setStatusIcon(null);
      showTestingOverlay();
    }

    function updateTestModalText() {
      ensureTestModalElements();
      if (!testStatusModal || !testStatusText) return;

      const sources = Object.keys(testProgress);
      const hasError = sources.some((key) => testProgress[key].status === "error");
      const allComplete = sources.every((key) => testProgress[key].status === "complete");

      if (hasError) {
        setStatusIcon("error");
        const errorMessages = sources
          .filter((key) => testProgress[key].status === "error")
          .map((key) => testProgress[key].message || `${key} test failed`);
        testStatusText.textContent = `Test errors: ${errorMessages.join("; ")}`;
        testStatusModal.style.display = "flex";
        releaseExclusiveSession("test_error");
        return;
      }

      if (allComplete) {
        const allStable = sources.every(
          (key) => testProgress[key].serverStable === true
        );
        const anyUnstable = sources.some(
          (key) => testProgress[key].serverStable === false
        );

        if (allStable) {
          setStatusIcon("success");
          testStatusText.textContent = "Device recognized successfully (tests complete, you may close this page).";
        } else if (anyUnstable) {
          setStatusIcon("error");
          testStatusText.textContent = "Device anomaly detected (tests complete, you may close this page).";
        } else {
          setStatusIcon(null);
          testStatusText.textContent = "Tests complete, you may close this page.";
        }
        testStatusModal.style.display = "flex";
        releaseExclusiveSession("tests_complete");
        return;
      }

      // Default message during execution
      setStatusIcon(null);
      testStatusText.textContent = "Tests are running, please do not leave or interact with the page.";
      testStatusModal.style.display = "flex";
    }

    function handleTestStatusUpdate(source, type, payload) {
      if (!testProgress[source]) return;

      if (type === "testStarted") {
        testProgress[source] = { status: "running", message: "", serverStable: null };
        showTestingOverlay();
      } else if (type === "testComplete") {
        const serverStable =
          typeof payload?.serverAllStable === "boolean"
            ? payload.serverAllStable
            : typeof payload?.allStable === "boolean"
            ? payload.allStable
            : null;
        testProgress[source] = {
          status: "complete",
          message: payload?.alertMessage || "",
          serverStable,
        };
      } else if (type === "testError") {
        const message = payload?.message || "Unknown error";
        testProgress[source] = { status: "error", message, serverStable: false };
      }

      updateTestModalText();
    }

    window.addEventListener("message", (event) => {
      if (event.origin !== window.location.origin) return;
      const data = event.data;
      if (!data || typeof data !== "object") return;
      const { source, type, payload } = data;
      if (!source || !type) return;
      handleTestStatusUpdate(source, type, payload);
    });

    window.addEventListener("beforeunload", () => {
      releaseExclusiveSession("page_unload", true);
    });

    function showRegisterPopup(onSuccess) {
      const overlay = document.getElementById("overlay");
      const usernameInput = document.getElementById("usernameInput");
      const passwordInput = document.getElementById("passwordInput");
      const passwordWrapper = document.getElementById("passwordWrapper");
      const helper = document.getElementById("authHelper");
      const actionBtn = document.getElementById("actionBtn");
      const toggleLink = document.getElementById("toggleLink");
      const generatedPasswordContainer = document.getElementById("generatedPasswordContainer");
      const generatedPasswordValue = document.getElementById("generatedPasswordValue");
      const copyPasswordBtn = document.getElementById("copyPasswordBtn");

      let mode = "login";
      let registrationFinalized = false;

      function clearOverlayTimer() {
        if (overlayCloseTimer) {
          clearTimeout(overlayCloseTimer);
          overlayCloseTimer = null;
        }
      }

      function closeOverlay() {
        clearOverlayTimer();
        if (overlay && overlay.parentNode) {
          overlay.parentNode.removeChild(overlay);
        }
      }

      function finalizeRegistration(username) {
        if (registrationFinalized) return;
        registrationFinalized = true;
        clearOverlayTimer();
        closeOverlay();
        if (typeof onSuccess === "function") onSuccess(username);
      }

      function resetGeneratedPassword() {
        if (generatedPasswordContainer) {
          generatedPasswordContainer.style.display = "none";
        }
        if (generatedPasswordValue) {
          generatedPasswordValue.textContent = "—";
        }
        if (helper) {
          helper.textContent = "";
        }
        if (toggleLink) {
          toggleLink.style.display = "";
        }
      }

      if (copyPasswordBtn) {
        copyPasswordBtn.onclick = async () => {
          const passwordValue = generatedPasswordValue ? generatedPasswordValue.textContent : "";
          const password = passwordValue.trim();
          if (!password || password === "—") {
            if (helper) {
              helper.textContent = "No generated password available yet.";
            }
            return;
          }
          try {
            await navigator.clipboard.writeText(password);
            if (helper) {
              helper.textContent = "Assigned password copied to clipboard.";
            }
          } catch (err) {
            console.warn("Copy password failed:", err);
            if (helper) {
              helper.textContent = "Unable to copy automatically. Please copy the password manually.";
            }
          }
        };
      }

      function setMode(newMode) {
        mode = newMode;
        registrationFinalized = false;
        clearOverlayTimer();
        resetGeneratedPassword();

        const title = document.getElementById("modeTitle");
        if (!title || !actionBtn || !toggleLink) return;

        if (mode === "login") {
          title.textContent = "Sign In";
          actionBtn.textContent = "Sign In";
          toggleLink.textContent = "Don't have an account? Register";
          if (passwordWrapper) passwordWrapper.style.display = "block";
          if (passwordInput) {
            passwordInput.value = "";
            passwordInput.placeholder = "Password";
          }
          if (helper) helper.textContent = "";
        } else {
          title.textContent = "Create Account";
          actionBtn.textContent = "Register";
          toggleLink.textContent = "Already have an account? Sign in";
          if (passwordWrapper) passwordWrapper.style.display = "none";
          if (passwordInput) {
            passwordInput.value = "";
          }
          if (helper) {
            helper.textContent =
              "A strong password will be generated automatically. It will appear below after registration.";
          }
        }
      }

      setMode(mode);

      if (toggleLink) {
        toggleLink.onclick = (e) => {
          e.preventDefault();
          setMode(mode === "login" ? "register" : "login");
        };
      }

      if (actionBtn) {
        actionBtn.onclick = async () => {
          const usernameValue = usernameInput ? usernameInput.value : "";
          const username = usernameValue.trim();
          const password = passwordInput ? passwordInput.value : "";
          if (!username) {
            alert("Please enter a username.");
            return;
          }
          if (mode === "login" && !password) {
            alert("Please enter your password.");
            return;
          }

          const endpoint = mode === "login" ? "/login" : "/register";
          const payload = mode === "login" ? { username, password } : { username };

          try {
            const res = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const result = await res.json();
            if (!res.ok || result.status !== "ok") {
              const action = mode === "login" ? "Sign-in" : "Registration";
              alert(`${action} failed: ${result.error || "Unknown error"}`);
              return;
            }

            const generatedPassword = mode === "register" ? result.password : null;
            const lockResult = await acquireExclusiveSession(result.username);
            if (!lockResult.success) {
              let message = "";
              if (generatedPassword) {
                message =
                  `Registration successful.\nGenerated password: ${generatedPassword}\n` +
                  "The testing system is currently in use. Please keep the password safe and try again later.";
              } else if (lockResult.busy) {
                message =
                  `Sign-in succeeded, but the testing system is currently in use by ${lockResult.owner || "another user"}.\n` +
                  "Please try again later.";
              } else {
                message =
                  `Sign-in succeeded, but the system cannot start a session right now.\nReason: ${lockResult.error || "Unknown error"}`;
              }
              alert(message);
              return;
            }

            localStorage.setItem("currentUser", result.username);
            window.currentUser = result.username;

            if (mode === "login") {
              await captureFingerprint(result.username);
              finalizeRegistration(result.username);
              return;
            }

            await captureFingerprint(result.username);

            if (generatedPasswordContainer) {
              generatedPasswordContainer.style.display = "block";
            }
            if (generatedPasswordValue) {
              generatedPasswordValue.textContent = generatedPassword || "—";
            }
            if (toggleLink) {
              toggleLink.style.display = "none";
            }
            if (helper) {
              helper.textContent =
                "Assigned password generated. Copy it below, then click Continue to begin testing. This dialog will close automatically after 15 seconds.";
            }
            actionBtn.textContent = "Continue";
            actionBtn.onclick = () => finalizeRegistration(result.username);
            overlayCloseTimer = setTimeout(
              () => finalizeRegistration(result.username),
              15000
            );
          } catch (error) {
            console.error("Authentication request failed:", error);
            alert("Request failed, please try again later.");
          }
        };
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      showRegisterPopup((username) => {
        const webglFrame = document.getElementById("sys1");
        const audioFrame = document.getElementById("sys3");
        const canvasFrame = document.getElementById("sys4");
        if (webglFrame) {
          webglFrame.src = "/webgl/?autostart=1";
        }
        if (audioFrame) {
          audioFrame.src = "/audio/?autostart=1";
        }
        if (canvasFrame) {
          canvasFrame.src = "/canvas/?autostart=1";
        }
      });
    });
  </script>
</head>

<body>
  <h1>S-BFP Testing Platform</h1>
  <div style="display: flex; flex-wrap: wrap; gap: 2%; justify-content: center; margin: 0 auto 20px; max-width: 1500px;">
    <iframe id="sys1" style="flex: 1 1 45%; min-width: 320px; height: 500px; border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);"></iframe>
    <iframe id="sys3" style="flex: 1 1 45%; min-width: 320px; height: 500px; border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);"></iframe>
    <iframe id="sys4" style="flex: 1 1 45%; min-width: 320px; height: 500px; border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);"></iframe>
  </div>

  <!-- Authentication -->
  <div id="overlay">
    <div class="auth-box">
      <h3 id="modeTitle">Sign In</h3>
      <input id="usernameInput" placeholder="Username">
      <div id="passwordWrapper">
        <input id="passwordInput" type="password" placeholder="Password">
      </div>
      <p id="authHelper" class="auth-helper"></p>
      <div id="generatedPasswordContainer" class="generated-password">
        <label>Assigned Password</label>
        <div id="generatedPasswordValue" class="generated-password-value">—</div>
        <button id="copyPasswordBtn" type="button">Copy Password</button>
      </div>
      <button id="actionBtn">Sign In</button>
      <a id="toggleLink" href="#">Don't have an account? Register</a>
    </div>
  </div>


  <!-- Test Status Modal -->
  <div id="test-status-modal">
    <div id="test-status-box">
      <div id="test-status-icon" class="fingerprint-icon"></div>
      <div id="test-status-text">Tests are running, please do not leave or interact with the page.</div>
    </div>
  </div>
</body>
</html>
