<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Unified Testing Platform</title>
  <style>
    /* ========== Global Base Styles ========== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f8fafc;
      color: #333;
      margin: 0;
      text-align: center;
    }
    h1 {
      margin-top: 40px;
      color: #1e293b;
      font-weight: 600;
    }

    /* ========== Authentication Modal Styles ========== */
    #overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15, 23, 42, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .auth-box {
      background: white;
      padding: 40px 32px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      width: 320px;
      text-align: center;
      transition: all 0.3s ease;
    }
    .auth-box h3 {
      margin-bottom: 24px;
      color: #0f172a;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .auth-box input {
      width: 100%;
      padding: 10px 12px;
      margin: 8px 0;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .auth-box input:focus {
      border-color: #22d3ee;
      box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.25);
    }
    .auth-box button {
      width: 100%;
      padding: 10px;
      background: linear-gradient(90deg, #14b8a6, #06b6d4);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 16px;
      transition: background 0.25s;
    }
    .auth-box button:hover {
      background: linear-gradient(90deg, #0d9488, #0891b2);
    }
    .auth-box a {
      display: inline-block;
      margin-top: 12px;
      font-size: 13px;
      color: #475569;
      text-decoration: none;
      transition: color 0.2s;
    }
    .auth-box a:hover {
      color: #0e7490;
    }
    #passwordWrapper {
      width: 100%;
    }
    .auth-helper {
      font-size: 12px;
      color: #64748b;
      margin: 4px 0 0;
      min-height: 18px;
    }

    .generated-password {
      display: none;
      margin-top: 16px;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: #f8fafc;
      text-align: left;
    }
    .generated-password label {
      display: block;
      font-size: 13px;
      color: #0f172a;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .generated-password-value {
      font-family: monospace;
      font-size: 14px;
      padding: 8px 10px;
      background: #0f172a;
      color: #f8fafc;
      border-radius: 6px;
      margin-bottom: 8px;
      word-break: break-all;
    }
    .generated-password button {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 6px;
      background: #14b8a6;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    .generated-password button:hover {
      background: #0d9488;
    }

    /* ========== Consent Modal Styles ========== */
    #consent-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      z-index: 9999;
    }
    #consent-box {
      background: white;
      padding: 24px;
      border-radius: 16px;
      width: 95%;
      max-width: 1120px;
      text-align: left;
      box-shadow: 0 18px 60px rgba(15, 23, 42, 0.25);
      font-size: 14px;
    }
    #consent-buttons {
      text-align: right;
      margin-top: 20px;
    }
    #consent-buttons button {
      margin-left: 10px;
      padding: 8px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    #consent-accept { background-color: #10b981; color: white; }
    #consent-accept:hover { background-color: #059669; }
    #consent-decline { background-color: #e2e8f0; color: #334155; }
    #consent-decline:hover { background-color: #cbd5e1; }

    .consent-statement-container {
      border: 1px solid #cbd5e1;
      border-radius: 14px;
      overflow: hidden;
      background: #ffffff;
    }
    .consent-statement-header {
      background: #e2e8f0;
      color: #0f172a;
      padding: 18px 24px;
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      border-bottom: 1px solid #cbd5e1;
    }
    .consent-statement-content {
      display: flex;
      flex-wrap: wrap;
      gap: 0;
      background: #ffffff;
      border-bottom: 1px solid #e2e8f0;
    }
    .consent-statement-pane {
      flex: 1 1 320px;
      padding: 24px;
      max-height: 55vh;
      overflow-y: auto;
      line-height: 1.7;
      font-size: 15px;
      color: #1f2937;
    }
    .consent-statement-pane h2 {
      font-size: 18px;
      font-weight: 600;
      margin-top: 22px;
      padding-bottom: 6px;
      border-bottom: 1px solid #d1d5db;
    }
    .consent-statement-pane h2:first-of-type {
      margin-top: 0;
    }
    .consent-statement-pane p,
    .consent-statement-pane li {
      font-size: 15px;
      margin: 8px 0;
      text-align: justify;
    }
    .consent-statement-pane ul {
      margin: 8px 0 8px 20px;
      padding: 0;
    }
    .consent-statement-footer {
      background: #f8fafc;
      padding: 14px 24px;
      font-size: 14px;
      color: #475569;
      text-align: center;
    }
    @media (max-width: 900px) {
      .consent-statement-pane {
        max-height: 40vh;
      }
    }

    /* ========== Test Status Modal Styles ========== */
    #test-status-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.65);
      z-index: 9800;
    }
    #test-status-box {
      background: white;
      padding: 24px 32px;
      border-radius: 12px;
      width: 360px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      font-size: 16px;
      color: #0f172a;
      line-height: 1.6;
    }
    .fingerprint-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: none;
      margin: 0 auto 16px;
      background-size: cover;
    }
    .fingerprint-icon.success {
      display: inline-flex;
      background-image:
        repeating-radial-gradient(circle at center, rgba(255, 255, 255, 0.25) 0 6px, transparent 6px 12px),
        radial-gradient(circle at center, #22c55e 0%, #16a34a 70%, rgba(34, 197, 94, 0.7) 100%);
    }
    .fingerprint-icon.error {
      display: inline-flex;
      background-image:
        repeating-radial-gradient(circle at center, rgba(255, 255, 255, 0.25) 0 6px, transparent 6px 12px),
        radial-gradient(circle at center, #ef4444 0%, #dc2626 70%, rgba(239, 68, 68, 0.7) 100%);
    }
  </style>

    <script type="module">
    import { getFullFingerprint } from "/webgl/preliminary_fingerprint.js";

    async function captureFingerprint(username) {
      if (!username) return;
      try {
        const captureStartedAt = Date.now();
        const fingerprint = await getFullFingerprint();
        const captureFinishedAt = Date.now();
        await fetch("/user/fingerprint", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username,
            timestamp: new Date().toISOString(),
            fingerprintHash: fingerprint.hash,
            fingerprintString: fingerprint.string,
            fingerprint: fingerprint.raw,
            captureStartedAt: new Date(captureStartedAt).toISOString(),
            captureFinishedAt: new Date(captureFinishedAt).toISOString(),
            fingerprintDurationMs: captureFinishedAt - captureStartedAt,
          }),
        });
      } catch (error) {
        console.error("Static fingerprint capture failed:", error);
      }
    }

    const testProgress = {
      webgl: { status: "idle", message: "", serverStable: null },
      webgl2: { status: "idle", message: "", serverStable: null },
      audio: { status: "idle", message: "", serverStable: null },
      canvas: { status: "idle", message: "", serverStable: null },
    };
    let testStatusModal = null;
    let testStatusText = null;
    let testStatusIcon = null;
    let sessionToken = null;
    let pendingSessionReleasePayload = null;
    let sessionHeartbeatTimer = null;
    let sessionReleased = true;
    const SESSION_HEARTBEAT_MIN_INTERVAL = 10;
    const AUTO_CLOSE_DELAY_MS = 5000;
    let autoCloseTimer = null;
    let overlayCloseTimer = null;

    function scheduleAutoClose(reason = "completed") {
      if (autoCloseTimer) {
        return;
      }
      if (testStatusText) {
        const note = " (Please close this page.)";
        if (!testStatusText.textContent.includes("auto-close") && !testStatusText.textContent.includes("è‡ªåŠ¨å…³é—­")) {
          testStatusText.textContent = `${testStatusText.textContent}${note}`;
        }
      }
      autoCloseTimer = setTimeout(async () => {
        await releaseExclusiveSession(`auto_close_${reason}`, false, true);
        try {
          window.open('', '_self');
          window.close();
        } catch (error) {
          // ignore
        }
        if (!window.closed) {
          window.location.replace("/");
        }
        autoCloseTimer = null;
      }, AUTO_CLOSE_DELAY_MS);
    }

    function clearSessionHeartbeat() {
      if (sessionHeartbeatTimer) {
        clearInterval(sessionHeartbeatTimer);
        sessionHeartbeatTimer = null;
      }
    }

    function scheduleSessionHeartbeat(timeoutSeconds) {
      clearSessionHeartbeat();
      const intervalSeconds = Math.max(
        SESSION_HEARTBEAT_MIN_INTERVAL,
        Math.floor((timeoutSeconds || 60) / 2)
      );
      sessionHeartbeatTimer = setInterval(() => {
        if (!sessionToken || sessionReleased) return;
        sendSessionHeartbeat().catch((error) => {
          console.warn("Heartbeat failed:", error);
        });
      }, intervalSeconds * 1000);
    }

    async function acquireExclusiveSession(username) {
      try {
        const res = await fetch("/session/acquire", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username }),
        });
        const result = await res.json();
        if (!res.ok) {
          const err = result.error || result.message || res.statusText;
          return { success: false, error: err };
        }
        if (result.status === "busy") {
          return {
            success: false,
            busy: true,
            owner: result.owner,
            startedAt: result.startedAt || null,
          };
        }
        if (result.status !== "ok" || !result.token) {
          return {
            success: false,
            error: result.error || "Failed to acquire exclusive session.",
          };
        }
        sessionToken = result.token;
        pendingSessionReleasePayload = {
          username: result.username || username,
          token: result.token,
        };
        sessionReleased = false;
        scheduleSessionHeartbeat(result.timeout);
        return { success: true, timeout: result.timeout };
      } catch (error) {
        return { success: false, error: error.message || String(error) };
      }
    }

    async function sendSessionHeartbeat() {
      if (!window.currentUser || !sessionToken) return;
      const res = await fetch("/session/heartbeat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: window.currentUser, token: sessionToken }),
      });
      if (!res.ok) {
        const result = await res.json().catch(() => ({}));
        throw new Error(result.error || res.statusText);
      }
    }

    async function releaseExclusiveSession(reason = "manual", useBeacon = false, force = false) {
      const payload = pendingSessionReleasePayload || (sessionToken
        ? { username: window.currentUser, token: sessionToken }
        : null);
      if (!window.currentUser || !payload) return;
      if (sessionReleased && !force) return;

      sessionReleased = true;
      clearSessionHeartbeat();
      const bodyPayload = { ...payload, reason };

      if (useBeacon && navigator.sendBeacon) {
        try {
          const blob = new Blob([JSON.stringify(bodyPayload)], {
            type: "application/json",
          });
          navigator.sendBeacon("/session/release", blob);
          sessionToken = null;
          pendingSessionReleasePayload = null;
          return;
        } catch (error) {
          console.warn("Failed to send beacon release:", error);
        }
      }

      try {
        const res = await fetch("/session/release", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyPayload),
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        sessionToken = null;
        pendingSessionReleasePayload = null;
      } catch (error) {
        console.warn("Failed to release session:", error);
        if (navigator.sendBeacon) {
          try {
            const blob = new Blob([JSON.stringify(bodyPayload)], {
              type: "application/json",
            });
            if (navigator.sendBeacon("/session/release", blob)) {
              sessionToken = null;
              pendingSessionReleasePayload = null;
              return;
            }
          } catch (beaconError) {
            console.warn("Beacon release attempt failed:", beaconError);
          }
        }
        if (force) {
          pendingSessionReleasePayload = { ...bodyPayload };
        } else {
          sessionReleased = false;
          pendingSessionReleasePayload = { ...bodyPayload };
        }
      }
    }

    function ensureTestModalElements() {
      if (!testStatusModal) {
        testStatusModal = document.getElementById("test-status-modal");
      }
      if (!testStatusText) {
        testStatusText = document.getElementById("test-status-text");
      }
      if (!testStatusIcon) {
        testStatusIcon = document.getElementById("test-status-icon");
      }
    }

    function setStatusIcon(mode) {
      ensureTestModalElements();
      if (!testStatusIcon) return;
      testStatusIcon.classList.remove("success", "error");
      if (!mode) {
        testStatusIcon.style.display = "none";
        return;
      }
      testStatusIcon.style.display = "inline-flex";
      testStatusIcon.classList.add(mode === "success" ? "success" : "error");
    }

    function showTestingOverlay() {
      ensureTestModalElements();
      if (!testStatusModal || !testStatusText) return;
      testStatusText.textContent = "Tests are running, please do not leave or interact with the page.";
      testStatusModal.style.display = "flex";
    }

    function resetTestProgress() {
      testProgress.webgl = { status: "pending", message: "", serverStable: null };
      testProgress.webgl2 = { status: "pending", message: "", serverStable: null };
      testProgress.audio = { status: "pending", message: "", serverStable: null };
      testProgress.canvas = { status: "pending", message: "", serverStable: null };
      setStatusIcon(null);
      showTestingOverlay();
    }

    function updateTestModalText() {
      ensureTestModalElements();
      if (!testStatusModal || !testStatusText) return;

      const sources = Object.keys(testProgress);
      const hasError = sources.some((key) => testProgress[key].status === "error");
      const allComplete = sources.every((key) => testProgress[key].status === "complete");

      if (hasError) {
        setStatusIcon("error");
        const errorMessages = sources
          .filter((key) => testProgress[key].status === "error")
          .map((key) => testProgress[key].message || `${key} test failed`);
        testStatusText.textContent = `Test errors: ${errorMessages.join("; ")}`;
        testStatusModal.style.display = "flex";
        releaseExclusiveSession("test_error");
        scheduleAutoClose("error");
        return;
      }

      if (allComplete) {
        const allStable = sources.every(
          (key) => testProgress[key].serverStable === true
        );
        const anyUnstable = sources.some(
          (key) => testProgress[key].serverStable === false
        );

        if (allStable) {
          setStatusIcon("success");
          testStatusText.textContent = "Device recognized successfully (tests complete, you may close this page).";
        } else if (anyUnstable) {
          setStatusIcon("error");
          testStatusText.textContent = "Device anomaly detected (tests complete, you may close this page).";
        } else {
          setStatusIcon(null);
          testStatusText.textContent = "Tests complete, you may close this page.";
        }
        testStatusModal.style.display = "flex";
        releaseExclusiveSession("tests_complete");
        scheduleAutoClose("complete");
        return;
      }

      // Default message during execution
      setStatusIcon(null);
      testStatusText.textContent = "Tests are running, please do not leave or interact with the page.";
      testStatusModal.style.display = "flex";
    }

    function handleTestStatusUpdate(source, type, payload) {
      if (!testProgress[source]) return;

      if (type === "testStarted") {
        testProgress[source] = { status: "running", message: "", serverStable: null };
        showTestingOverlay();
      } else if (type === "testComplete") {
        const serverStable =
          typeof payload?.serverAllStable === "boolean"
            ? payload.serverAllStable
            : typeof payload?.allStable === "boolean"
            ? payload.allStable
            : null;
        testProgress[source] = {
          status: "complete",
          message: payload?.alertMessage || "",
          serverStable,
        };
      } else if (type === "testError") {
        const message = payload?.message || "Unknown error";
        testProgress[source] = { status: "error", message, serverStable: false };
      }

      updateTestModalText();
    }

    window.addEventListener("message", (event) => {
      if (event.origin !== window.location.origin) return;
      const data = event.data;
      if (!data || typeof data !== "object") return;
      const { source, type, payload } = data;
      if (!source || !type) return;
      handleTestStatusUpdate(source, type, payload);
    });

    window.addEventListener("beforeunload", () => {
      releaseExclusiveSession("page_unload", true);
    });

    function showRegisterPopup(onSuccess) {
      const overlay = document.getElementById("overlay");
      const usernameInput = document.getElementById("usernameInput");
      const passwordInput = document.getElementById("passwordInput");
      const passwordWrapper = document.getElementById("passwordWrapper");
      const helper = document.getElementById("authHelper");
      const actionBtn = document.getElementById("actionBtn");
      const toggleLink = document.getElementById("toggleLink");
      const generatedPasswordContainer = document.getElementById("generatedPasswordContainer");
      const generatedPasswordValue = document.getElementById("generatedPasswordValue");
      const copyPasswordBtn = document.getElementById("copyPasswordBtn");

      let mode = "login";
      let registrationFinalized = false;

      function clearOverlayTimer() {
        if (overlayCloseTimer) {
          clearTimeout(overlayCloseTimer);
          overlayCloseTimer = null;
        }
      }

      function closeOverlay() {
        clearOverlayTimer();
        if (overlay && overlay.parentNode) {
          overlay.parentNode.removeChild(overlay);
        }
      }

      function finalizeRegistration(username) {
        if (registrationFinalized) return;
        registrationFinalized = true;
        clearOverlayTimer();
        closeOverlay();
        if (typeof onSuccess === "function") onSuccess(username);
      }

      function resetGeneratedPassword() {
        if (generatedPasswordContainer) {
          generatedPasswordContainer.style.display = "none";
        }
        if (generatedPasswordValue) {
          generatedPasswordValue.textContent = "â€”";
        }
        if (helper) {
          helper.textContent = "";
        }
        if (toggleLink) {
          toggleLink.style.display = "";
        }
      }

      if (copyPasswordBtn) {
        copyPasswordBtn.onclick = async () => {
          const passwordValue = generatedPasswordValue ? generatedPasswordValue.textContent : "";
          const password = passwordValue.trim();
          if (!password || password === "â€”") {
            if (helper) {
              helper.textContent = "No generated password available yet.";
            }
            return;
          }
          try {
            await navigator.clipboard.writeText(password);
            if (helper) {
              helper.textContent = "Assigned password copied to clipboard.";
            }
          } catch (err) {
            console.warn("Copy password failed:", err);
            if (helper) {
              helper.textContent = "Unable to copy automatically. Please copy the password manually.";
            }
          }
        };
      }

      function setMode(newMode) {
        mode = newMode;
        registrationFinalized = false;
        clearOverlayTimer();
        resetGeneratedPassword();

        const title = document.getElementById("modeTitle");
        if (!title || !actionBtn || !toggleLink) return;

        if (mode === "login") {
          title.textContent = "Sign In";
          actionBtn.textContent = "Sign In";
          toggleLink.textContent = "Don't have an account? Register";
          if (passwordWrapper) passwordWrapper.style.display = "block";
          if (passwordInput) {
            passwordInput.value = "";
            passwordInput.placeholder = "Password";
          }
          if (helper) helper.textContent = "";
        } else {
          title.textContent = "Create Account";
          actionBtn.textContent = "Register";
          toggleLink.textContent = "Already have an account? Sign in";
          if (passwordWrapper) passwordWrapper.style.display = "none";
          if (passwordInput) {
            passwordInput.value = "";
          }
          if (helper) {
            helper.textContent =
              "A strong password will be generated automatically. It will appear below after registration.";
          }
        }
      }

      setMode(mode);

      if (toggleLink) {
        toggleLink.onclick = (e) => {
          e.preventDefault();
          setMode(mode === "login" ? "register" : "login");
        };
      }

      if (actionBtn) {
        actionBtn.onclick = async () => {
          const usernameValue = usernameInput ? usernameInput.value : "";
          const username = usernameValue.trim();
          const password = passwordInput ? passwordInput.value : "";
          if (!username) {
            alert("Please enter a username.");
            return;
          }
          if (mode === "login" && !password) {
            alert("Please enter your password.");
            return;
          }

          const endpoint = mode === "login" ? "/login" : "/register";
          const payload = mode === "login" ? { username, password } : { username };

          try {
            const res = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const result = await res.json();
            if (!res.ok || result.status !== "ok") {
              const action = mode === "login" ? "Sign-in" : "Registration";
              alert(`${action} failed: ${result.error || "Unknown error"}`);
              return;
            }

            const generatedPassword = mode === "register" ? result.password : null;
            const lockResult = await acquireExclusiveSession(result.username);
            if (!lockResult.success) {
              let message = "";
              if (generatedPassword) {
                message =
                  `Registration successful.\nGenerated password: ${generatedPassword}\n` +
                  "The testing system is currently in use. Please keep the password safe and try again later.";
              } else if (lockResult.busy) {
                message =
                  `Sign-in succeeded, but the testing system is currently in use by ${lockResult.owner || "another user"}.\n` +
                  "Please try again later.";
              } else {
                message =
                  `Sign-in succeeded, but the system cannot start a session right now.\nReason: ${lockResult.error || "Unknown error"}`;
              }
              alert(message);
              return;
            }

            localStorage.setItem("currentUser", result.username);
            window.currentUser = result.username;

            if (mode === "login") {
              await captureFingerprint(result.username);
              finalizeRegistration(result.username);
              return;
            }

            await captureFingerprint(result.username);

            if (generatedPasswordContainer) {
              generatedPasswordContainer.style.display = "block";
            }
            if (generatedPasswordValue) {
              generatedPasswordValue.textContent = generatedPassword || "â€”";
            }
            if (toggleLink) {
              toggleLink.style.display = "none";
            }
            if (helper) {
              helper.textContent =
                "Assigned password generated. Copy it below, then click Continue to begin testing. This dialog will close automatically after 15 seconds.";
            }
            actionBtn.textContent = "Continue";
            actionBtn.onclick = () => finalizeRegistration(result.username);
            overlayCloseTimer = setTimeout(
              () => finalizeRegistration(result.username),
              15000
            );
          } catch (error) {
            console.error("Authentication request failed:", error);
            alert("Request failed, please try again later.");
          }
        };
      }
    }

    function showConsentModal(onAgree, onDecline) {
      const modal = document.getElementById("consent-modal");
      if (!modal) {
        console.error("Unable to find the consent-modal element!");
        return;
      }
      modal.style.display = "flex";

      document.getElementById("consent-accept").onclick = async () => {
        modal.style.display = "none";
        await fetch("/consent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ consent: true, timestamp: new Date().toISOString(), username: window.currentUser }),
        });
        resetTestProgress();
        if (typeof onAgree === "function") onAgree();
      };

      document.getElementById("consent-decline").onclick = async () => {
        modal.style.display = "none";
        await fetch("/consent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ consent: false, timestamp: new Date().toISOString(), username: window.currentUser }),
        });
        releaseExclusiveSession("consent_declined");
        if (typeof onDecline === "function") onDecline();
      };
    }

    window.addEventListener("DOMContentLoaded", () => {
      showRegisterPopup((username) => {
        showConsentModal(
          () => {
            const webglFrame = document.getElementById("sys1");
            const webgl2Frame = document.getElementById("sys2");
            const audioFrame = document.getElementById("sys3");
            const canvasFrame = document.getElementById("sys4");
            if (webglFrame) {
              webglFrame.src = "/webgl/?autostart=1";
            }
            if (webgl2Frame) {
              webgl2Frame.src = "/webgl2/?autostart=1";
            }
            if (audioFrame) {
              audioFrame.src = "/audio/?autostart=1";
            }
            if (canvasFrame) {
              canvasFrame.src = "/canvas/?autostart=1";
            }
          },
          () => {
            alert("You declined to participate; this page will not collect any browser fingerprint data.");
          }
        );
      });
    });
  </script>
</head>

<body>
  <h1>Unified Testing Platform</h1>
  <div style="display: flex; flex-wrap: wrap; gap: 2%; justify-content: center; margin: 0 auto 20px; max-width: 1500px;">
    <iframe id="sys1" style="flex: 1 1 45%; min-width: 320px; height: 500px; border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);"></iframe>
    <iframe id="sys2" style="flex: 1 1 45%; min-width: 320px; height: 500px; border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);"></iframe>
    <iframe id="sys3" style="flex: 1 1 45%; min-width: 320px; height: 500px; border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);"></iframe>
    <iframe id="sys4" style="flex: 1 1 45%; min-width: 320px; height: 500px; border: none; border-radius: 12px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);"></iframe>
  </div>

  <!-- Authentication -->
  <div id="overlay">
    <div class="auth-box">
      <h3 id="modeTitle">Sign In</h3>
      <input id="usernameInput" placeholder="Username">
      <div id="passwordWrapper">
        <input id="passwordInput" type="password" placeholder="Password">
      </div>
      <p id="authHelper" class="auth-helper"></p>
      <div id="generatedPasswordContainer" class="generated-password">
        <label>Assigned Password</label>
        <div id="generatedPasswordValue" class="generated-password-value">â€”</div>
        <button id="copyPasswordBtn" type="button">Copy Password</button>
      </div>
      <button id="actionBtn">Sign In</button>
      <a id="toggleLink" href="#">Don't have an account? Register</a>
    </div>
  </div>

  <!-- Consent Modal -->
  <div id="consent-modal">
    <div id="consent-box">
      <div class="consent-statement-container">
        <div class="consent-statement-header">
          ğŸ§­ Research Participation and Data Collection Statement / ç ”ç©¶å‚ä¸ä¸æ•°æ®æ”¶é›†å£°æ˜
        </div>
        <div class="consent-statement-content">
          <div class="consent-statement-pane">
            <h2>1. Research Overview</h2>
            <p>This research is organized by <strong>Professor Wu Shujiangâ€™s research team</strong> at the School of Computer Science, Beihang University. The study focuses on developing a <strong>risk-based user authentication mechanism based on browser fingerprinting technologies</strong>.</p>
            <p>The core objective is to explore the expressive capability, stability, and privacy implications of browser fingerprinting for Web authentication, and to design a more secure and usable adaptive authentication framework.</p>
            <p>All outcomes are for <strong>academic and research purposes only</strong>, including scholarly publications and conference presentations, with <strong>no commercial use</strong> involved.</p>

            <h2>2. Introduction to Browser Fingerprinting</h2>
            <p>A â€œbrowser fingerprintâ€ refers to the combination of technical characteristics your browser and device reveal when visiting a website, such as screen size, installed fonts, or browser version. Individually, these details are ordinary; together, they create a highly distinctive digital signature.</p>
            <p>This research aims to analyze such characteristics systematically and study how they can enhance intelligent and privacy-aware authentication systems.</p>

            <h2>3. Scope and Purpose of Data Collection</h2>
            <p>During voluntary participation, our system may automatically collect certain non-personal environment data for analytical purposes. The data collected may include:</p>
            <ul>
              <li>Basic browser info (User-Agent, version, OS, language)</li>
              <li>Display details (resolution, pixel ratio, color depth, viewport size)</li>
              <li>Time zone and locale</li>
              <li>Browser capability and API support data</li>
              <li>Fingerprints from Canvas, WebGL, and AudioContext technologies</li>
              <li>Interaction statistics (e.g., timing or behavioral variance) for stability evaluation</li>
            </ul>
            <p>We <strong>do not collect personally identifiable information</strong> (name, email, IP, or login credentials), nor associate data with any user identity.</p>

            <h2>4. Data Storage, Security, and Access</h2>
            <p>All data are accessible only to authorized team members and are securely stored on Beihang Universityâ€™s research servers. Security measures include <strong>encryption, access control, anonymization, and audit logging</strong>.</p>
            <p>Data are retained only for the research duration and will be permanently deleted after completion. Publications include only aggregated results.</p>

            <h2>5. Voluntary Participation and Consent</h2>
            <p>Participation is completely voluntary. You may choose to â€œAgreeâ€ or â€œDeclineâ€ before any data collection begins. Choosing â€œAgreeâ€ indicates that you fully understand and consent to the use of anonymized fingerprint data solely for research purposes.</p>
            <p>You may withdraw participation or request data deletion anytime by contacting the research team. Withdrawal will not cause any adverse consequence.</p>

            <h2>6. Ethical Standards and Compliance</h2>
            <p>This research complies with <strong>ethical review</strong> and international standards on privacy, data protection, and responsible academic research.</p>
            <p>All study activities follow the principles of <strong>informed consent, minimal necessity, anonymization, and data transparency</strong>.</p>

            <h2>7. Contact Information</h2>
            <p>ğŸ“§ 23373306@buaa.edu.cn / andaul951@gmail.com</p>
          </div>
          <div class="consent-statement-pane">
            <h2>ä¸€ã€ç ”ç©¶é¡¹ç›®æ¦‚è¿°</h2>
            <p>æœ¬ç ”ç©¶ç”±<strong>åŒ—äº¬èˆªç©ºèˆªå¤©å¤§å­¦è®¡ç®—æœºå­¦é™¢å·«èœ€æ±Ÿè€å¸ˆç ”ç©¶å›¢é˜Ÿ</strong>ç»„ç»‡å¼€å±•ï¼Œç ”ç©¶æ–¹å‘ä¸ºåŸºäºæµè§ˆå™¨æŒ‡çº¹çš„é£é™©è‡ªé€‚åº”ç”¨æˆ·è®¤è¯æœºåˆ¶ã€‚</p>
            <p>ç ”ç©¶çš„æ ¸å¿ƒç›®æ ‡æ˜¯æ¢ç´¢æµè§ˆå™¨æŒ‡çº¹æŠ€æœ¯åœ¨ Web ç”¨æˆ·èº«ä»½è®¤è¯ä¸­çš„ç‰¹å¾è¡¨è¾¾èƒ½åŠ›ã€ç¨³å®šæ€§ä¸éšç§å½±å“ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè®¾è®¡æ›´å…·å®‰å…¨æ€§ä¸å¯ç”¨æ€§çš„é£é™©è‡ªé€‚åº”è®¤è¯ç³»ç»Ÿã€‚</p>
            <p>ç ”ç©¶æˆæœä»…ç”¨äº<strong>ç§‘å­¦ç ”ç©¶ä¸å­¦æœ¯äº¤æµ</strong>ï¼ŒåŒ…æ‹¬è®ºæ–‡å‘è¡¨ã€å­¦æœ¯ä¼šè®®æŠ¥å‘ŠåŠå›½é™…å­¦æœ¯æœŸåˆŠæŠ•ç¨¿ï¼Œä¸æ¶‰åŠä»»ä½•å•†ä¸šç”¨é€”ã€‚</p>

            <h2>äºŒã€æµè§ˆå™¨æŒ‡çº¹ç®€ä»‹</h2>
            <p>â€œæµè§ˆå™¨æŒ‡çº¹â€æ˜¯æŒ‡æ‚¨çš„æµè§ˆå™¨å’Œè®¾å¤‡åœ¨è®¿é—®ç½‘ç«™æ—¶æ‰€é€éœ²çš„ç»¼åˆæŠ€æœ¯ç‰¹å¾ï¼Œå¦‚å±å¹•å¤§å°ã€ç³»ç»Ÿå­—ä½“ã€æµè§ˆå™¨ç‰ˆæœ¬ç­‰ã€‚è¿™äº›ä¿¡æ¯å•ç‹¬çœ‹å¹³å¸¸ï¼Œä½†ç»„åˆåå…·æœ‰é«˜åº¦è¾¨è¯†åº¦ã€‚</p>
            <p>æœ¬ç ”ç©¶æ—¨åœ¨ç³»ç»Ÿåˆ†ææŒ‡çº¹ç‰¹å¾ï¼Œæ¢ç´¢å…¶åœ¨æ™ºèƒ½åŒ–å’Œéšç§å‹å¥½çš„èº«ä»½è®¤è¯ä¸­çš„åº”ç”¨ã€‚</p>

            <h2>ä¸‰ã€æ•°æ®æ”¶é›†çš„èŒƒå›´ä¸ç›®çš„</h2>
            <p>åœ¨æ‚¨è‡ªæ„¿å‚ä¸æœ¬å®éªŒçš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿå¯èƒ½ä¼šè‡ªåŠ¨æ”¶é›†éƒ¨åˆ†ä¸æµè§ˆå™¨å’Œè®¾å¤‡ç¯å¢ƒç›¸å…³çš„æ•°æ®ï¼Œç”¨äºç§‘ç ”åˆ†æå’Œæ¨¡å‹è¯„ä¼°ã€‚åŒ…æ‹¬ä½†ä¸é™äºï¼š</p>
            <ul>
              <li>æµè§ˆå™¨ä¿¡æ¯ï¼ˆUser-Agentã€ç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿã€è¯­è¨€ï¼‰</li>
              <li>æ˜¾ç¤ºç‰¹å¾ï¼ˆåˆ†è¾¨ç‡ã€åƒç´ æ¯”ã€é¢œè‰²æ·±åº¦ã€è§†å£å¤§å°ï¼‰</li>
              <li>æ—¶åŒºä¸åœ°åŒºä¿¡æ¯</li>
              <li>æµè§ˆå™¨åŠŸèƒ½ä¸ API æ”¯æŒæƒ…å†µ</li>
              <li>Canvasã€WebGLã€AudioContext ç­‰æŠ€æœ¯ç”Ÿæˆçš„æŒ‡çº¹ç‰¹å¾</li>
              <li>äº¤äº’ç»Ÿè®¡ç‰¹å¾ï¼ˆæ—¶é—´é—´éš”æˆ–è¡Œä¸ºæ³¢åŠ¨ï¼‰</li>
            </ul>
            <p>ç ”ç©¶å›¢é˜Ÿ<strong>ä¸ä¼šä¸»åŠ¨æ”¶é›†ä»»ä½•ä¸ªäººèº«ä»½ä¿¡æ¯</strong>ï¼ˆå§“åã€é‚®ç®±ã€è´¦å·ã€IP åœ°å€ç­‰ï¼‰ï¼Œä¹Ÿä¸ä¼šä¸ç”¨æˆ·èº«ä»½å»ºç«‹å…³è”ã€‚</p>

            <h2>å››ã€æ•°æ®å­˜å‚¨ã€å®‰å…¨ä¸è®¿é—®æ§åˆ¶</h2>
            <p>æ‰€æœ‰æ•°æ®ä»…é™æˆæƒçš„ç ”ç©¶å›¢é˜Ÿæˆå‘˜è®¿é—®ï¼Œå¹¶å­˜å‚¨äºåŒ—èˆªç ”ç©¶æœåŠ¡å™¨ä¸­ã€‚å›¢é˜Ÿéµå®ˆä¸¥æ ¼çš„æ•°æ®å®‰å…¨è§„èŒƒï¼ŒåŒ…æ‹¬<strong>åŠ å¯†å­˜å‚¨ã€æƒé™æ§åˆ¶ã€åŒ¿ååŒ–ä¸æ—¥å¿—å®¡è®¡</strong>ã€‚</p>
            <p>æ•°æ®ä»…åœ¨ç§‘ç ”é¡¹ç›®æ‰§è¡ŒæœŸé—´ä¿å­˜ï¼Œé¡¹ç›®ç»“æŸåå°†è¢«å½»åº•åˆ é™¤ã€‚ç ”ç©¶æŠ¥å‘Šä¸­ä»…å±•ç¤ºèšåˆåçš„ç»Ÿè®¡ç»“æœã€‚</p>

            <h2>äº”ã€è‡ªæ„¿å‚ä¸ä¸çŸ¥æƒ…åŒæ„</h2>
            <p>æœ¬ç ”ç©¶å®Œå…¨åŸºäºè‡ªæ„¿åŸåˆ™ã€‚æ‚¨å¯ä»¥åœ¨æ•°æ®é‡‡é›†å‰é€‰æ‹©â€œåŒæ„â€æˆ–â€œæ‹’ç»â€ã€‚é€‰æ‹©â€œåŒæ„â€è¡¨ç¤ºæ‚¨å·²å……åˆ†ç†è§£å¹¶æˆæƒç ”ç©¶å›¢é˜Ÿåœ¨åŒ¿ååŒ–å‰æä¸‹ä½¿ç”¨ç›¸å…³æ•°æ®ã€‚</p>
            <p>æ‚¨å¯éšæ—¶è”ç³»ç ”ç©¶å›¢é˜Ÿæ’¤å›å‚ä¸æˆ–åˆ é™¤æ•°æ®ï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•ä¸åˆ©å½±å“ã€‚</p>

            <h2>å…­ã€ä¼¦ç†è§„èŒƒä¸å­¦æœ¯åˆè§„</h2>
            <p>æœ¬ç ”ç©¶éµå®ˆ<strong>ç§‘ç ”ä¼¦ç†å®¡æŸ¥åˆ¶åº¦</strong>åŠå›½é™…å­¦æœ¯ç•Œå…³äºéšç§ä¿æŠ¤ã€äººç±»ç ”ç©¶ä¼¦ç†ä¸æ•°æ®å®‰å…¨çš„æ ‡å‡†ã€‚</p>
            <p>æ‰€æœ‰ç ”ç©¶æ´»åŠ¨éµå¾ª<strong>çŸ¥æƒ…åŒæ„ã€æœ€å°å¿…è¦æ€§ã€åŒ¿ååŒ–ä¸æ•°æ®é€æ˜</strong>çš„åŸåˆ™ï¼Œç¡®ä¿å…¬æ­£ã€å®‰å…¨ä¸ç§‘ç ”è¯šä¿¡ã€‚</p>

            <h2>ä¸ƒã€è”ç³»æ–¹å¼</h2>
            <p>ğŸ“§ 23373306@buaa.edu.cn / andaul951@gmail.com</p>
          </div>
        </div>

      </div>
      <div id="consent-buttons">
        <button id="consent-decline">Decline / æ‹’ç»</button>
        <button id="consent-accept">Agree / åŒæ„</button>
      </div>
    </div>
  </div>

  <!-- Test Status Modal -->
  <div id="test-status-modal">
    <div id="test-status-box">
      <div id="test-status-icon" class="fingerprint-icon"></div>
      <div id="test-status-text">Tests are running, please do not leave or interact with the page.</div>
    </div>
  </div>
</body>
</html>
